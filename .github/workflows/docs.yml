name: Deploy DocC Documentation

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      version:
        description: 'Documentation version'
        required: false
        default: latest'

permissions:
  contents: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Get Version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="latest"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building documentation for version: $VERSION"

      - name: Build DocC
        id: build
        uses: space-code/build-docc@main
        with:
          schemes: '["ValidatorCore", "ValidatorUI"]'
          version: ${{ steps.version.outputs.version }}

      - name: Generate Index Page
        uses: space-code/generate-index@v1.0.0
        with:
          version: ${{ steps.version.outputs.version }}
          project-name: 'Validator'
          project-description: 'Validator is a modern, lightweight Swift framework that provides elegant and type-safe input validation.'
          modules: |
            [
              {
                "name": "ValidatorCore",
                "path": "validatorcore",
                "description": "Core validation functionality and rules for Swift applications. Contains base types, protocols, and validator implementations.",
                "badge": "Core Module"
              },
              {
                "name": "ValidatorUI",
                "path": "validatorui",
                "description": "UI components and helpers for building validation interfaces. Ready-to-use solutions for SwiftUI and UIKit.",
                "badge": "UI Module"
              }
            ]

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs